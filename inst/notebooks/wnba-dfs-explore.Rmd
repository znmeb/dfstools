---
title: "Exploring WNBA DFS Data"
output: html_notebook
---

## Load libraries and data
```{r message=FALSE}
library(tidyverse)
library(DT)
library(dfstools)
library(Rmixmod)
library(mclust)
library(gt)
regular_season_schedule <- dfstools::bdb_wnba_schedule(
  "~/DFS/NBAStuffer_WNBA/2019_WNBA_Regular_Season_Original_Schedule.xlsx"
)
this_week <- regular_season_schedule %>% 
  dplyr::filter(
    game_start_time > '2019-07-01',
    game_start_time < '2019-07-08'
  )

season_dfs_feed <- dfstools::bdb_wnba_dfs(
  "~/Dropbox/19-wnba-dfs/06-30-2019-wnba-season-dfs-feed.xlsx"
) %>% dplyr::filter(!is.na(fanduel_salary), !is.na(draftkings_salary))

# negative points crash the GLM quasi-poisson
season_dfs_feed$fanduel_points <- 
  pmax(season_dfs_feed$fanduel_points, 0)
season_dfs_feed$draftkings_points <-
  pmax(season_dfs_feed$draftkings_points, 0)

season_dfs_feed <- season_dfs_feed %>% dplyr::mutate(
  fanduel_value = 1000 * fanduel_points / fanduel_salary,
  draftkings_value = 1000 * draftkings_points / draftkings_salary
)

player_box_score <- dfstools::player_box_score(
  "~/Dropbox/19-wnba-player/06-30-2019-wnba-season-player-feed.xlsx"
)
last_game_played <- season_dfs_feed %>% 
  dplyr::group_by(player, own_team) %>% 
  dplyr::summarize(games = n(), last_game = max(date)) %>% 
  ungroup()

# who's playing where?
road_players <- this_week %>% 
  dplyr::left_join(last_game_played, by = c("away" = "own_team")) %>%
  select(player, opponent_team = home) %>% 
  mutate(venue_r_h = "Road")
home_players <- this_week %>% 
  dplyr::left_join(last_game_played, by = c("home" = "own_team")) %>%
  select(player, opponent_team = away) %>% 
  mutate(venue_r_h = "Home")
to_project <- dplyr::bind_rows(road_players, home_players)

season_team_feed <- dfstools::bdb_wnba_team("~/Dropbox/19-wnba-team/06-30-2019-wnba-season-team-feed.xlsx")

```

## Game predictions
```{r}
game_data <- season_team_feed %>% 
  dplyr::mutate(
    binary.response = as.integer(home_pts > road_pts),
    neutral.site = 0
    ) %>% dplyr::select(
      home = home_team,
      away = road_team,
      home.response = home_pts,
      away.response = road_pts,
      binary.response,
      neutral.site,
      OT = num_ot
    )
rank_model <- dfstools::mvglmmRank_model(game_data)
augmented_schedule <- dfstools::game_predict(
  regular_season_schedule, rank_model
)
game_score_projections <- augmented_schedule %>%
  dplyr::semi_join(this_week) %>% 
  dplyr::select(
    `Game Start (EDT)` = game_start_time,
    "Road Team" = away,
    "Home Team" = home,
    "Projected Road Score" = away_score_p,
    "Projected Home Score" = home_score_p,
    "Projected Total" = total_p,
    "Projected Home Margin of Victory"= home_mov_p
  )
game_score_projections %>% gt() %>% 
  gtsave(filename = "game_score_projections_20190702.png")

```

## Archetypal analysis
```{r}
## Prepare archetypal analysis input
player_totals <- player_box_score %>% 
  mutate(player_name = player_full_name) %>% 
  select(
    player_name, tot, x3p, a, st, to, bl, pts, ddbl, tdbl, min, games) %>% 
  group_by(player_name) %>% 
  summarize_if(is.numeric, sum) %>% 
  ungroup()
player_labels <- player_totals %>% select(player_name)

## Compute the three-archetype model
archetypal_analysis <- dfstools::compute_archetypes(
  player_totals, player_labels, num_archetypes = 3)
player_alphas <- archetypal_analysis[["player_alphas"]] %>% 
  mutate(PlayerCode = as_factor(sprintf(
    "%s: Rim %1.4f, Floor %1.4f",
    player_name, 
    Rim, 
    Floor
  )))
datatable(player_alphas) %>% 
  formatRound(columns = c("Rim", "Floor", "Bench"), digits = 4)

```

## Fantasy points predictions
```{r}
fanduel_glmodel <- stats::glm(fanduel_points ~ 
    player + 
    opponent_team + 
    venue_r_h - 1, 
  data = season_dfs_feed, family = quasipoisson
)
draftkings_glmodel <- stats::glm(draftkings_points ~ 
    player + 
    opponent_team + 
    venue_r_h - 1, 
  data = season_dfs_feed, family = quasipoisson
)
dfs_projections <- to_project %>% 
  dplyr::mutate(
    projected_fanduel_points = predict(
      fanduel_glmodel, newdata = to_project, type = "response"),
    projected_draftkings_points = predict(
      draftkings_glmodel, newdata = to_project, type = "response")
  )

```

