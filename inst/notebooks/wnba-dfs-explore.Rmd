---
title: "Exploring WNBA DFS Data"
output: html_notebook
---

## Load libraries and data
```{r message=FALSE}
library(tidyverse)
library(DT)
library(dfstools)
library(Rmixmod)
library(mclust)
regular_season_schedule <- dfstools::bdb_wnba_schedule(
  "~/DFS/NBAStuffer_WNBA/2019_WNBA_Regular_Season_Original_Schedule.xlsx"
)

season_dfs_feed <- dfstools::bdb_wnba_dfs(
  "~/Dropbox/19-wnba-dfs/06-28-2019-wnba-season-dfs-feed.xlsx"
) %>% dplyr::filter(!is.na(fanduel_salary), !is.na(draftkings_salary))

player_box_score <- dfstools::player_box_score(
  "~/Dropbox/19-wnba-player/06-28-2019-wnba-season-player-feed.xlsx"
)

teams_playing <- tibble::enframe(c(
  "Dallas",
  "New York",
  "Chicago",
  "Seattle",
  "Indiana",
  "Phoenix"
), name = NULL, value = "own_team")

```

## Gaussian mixture model
```{r fig.width=16, fig.height=9}
mixture_input <- season_dfs_feed %>% 
  dplyr::select(
    minutes,
    fanduel_salary,
    fanduel_points,
    draftkings_salary,
    draftkings_points
  ) 
mixture_model <- Rmixmod::mixmodCluster(mixture_input, nbCluster = 3)
summary(mixture_model)
plot(mixture_model)
season_dfs_feed <- season_dfs_feed %>% 
  dplyr::mutate(partition = mixture_model@bestResult@partition)
partitions <- season_dfs_feed %>% 
  dplyr::group_by(partition) %>% 
  dplyr::summarize(count = n(), median_minutes = median(minutes)) %>% 
  dplyr::arrange(desc(median_minutes))

```

## Archetypal analysis
```{r}
## Prepare archetypal analysis input
player_totals <- player_box_score %>% 
  mutate(player_name = player_full_name) %>% 
  select(
    player_name, tot, x3p, a, st, to, bl, pts, ddbl, tdbl, min, games) %>% 
  group_by(player_name) %>% 
  summarize_if(is.numeric, sum) %>% 
  ungroup()
player_labels <- player_totals %>% select(player_name)

## Compute the three-archetype model
archetypal_analysis <- dfstools::compute_archetypes(
  player_totals, player_labels, num_archetypes = 3)
player_alphas <- archetypal_analysis[["player_alphas"]] %>% 
  mutate(PlayerCode = as_factor(sprintf(
    "%s: Rim %1.4f, Floor %1.4f",
    player_name, 
    Rim, 
    Floor
  )))
datatable(player_alphas) %>% 
  formatRound(columns = c("Rim", "Floor", "Bench"), digits = 4)

```


## FanDuel value line
```{r}
fanduel_data <- season_dfs_feed %>% filter(!is.na(fanduel_salary))
fanduel_model <- MASS::rlm(
  1000 * fanduel_points ~ fanduel_salary, data = fanduel_data
)
fanduel_value_line <- ggplot(
  data = fanduel_data, 
  aes(fanduel_salary, fanduel_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(fanduel_value_line)

```

## DraftKings value line
```{r}
draftkings_data <- season_dfs_feed %>% filter(!is.na(draftkings_salary))
draftkings_model <- MASS::rlm(
  1000 * draftkings_points ~ draftkings_salary, data = draftkings_data
)
draftkings_value_line <- ggplot(
  data = draftkings_data, 
  aes(draftkings_salary, draftkings_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(draftkings_value_line)

```

## FanDuel prediction model
```{r}
fanduel_filtered <- fanduel_data %>% 
  semi_join(teams_playing) %>% 
  filter(fanduel_points >= 0)
fanduel_glmodel <- stats::glm(fanduel_points ~ 
    fanduel_salary +
    player + 
    fanduel_position + 
    opponent_team + 
    starter_y_n + 
    venue_r_h - 1, 
  data = fanduel_filtered, family = quasipoisson
)
fanduel_augmented <- broom::augment(
  fanduel_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  select(-.se.fit, -.hat:-.std.resid) %>% 
  mutate(pct = 100 * .resid / fanduel_points)
fanduel_leaderboard <- fanduel_augmented %>% 
  group_by(player, fanduel_position) %>% summarize(
    count = n(), 
    p50 = quantile(.resid, 0.50, names = FALSE), 
    p75 = quantile(.resid, 0.75, names = FALSE),
    p95 = quantile(.resid, 0.95, names = FALSE)
  ) %>% 
  arrange(desc(p50))
datatable(fanduel_leaderboard) %>% 
  formatRound(columns = c("p50", "p75", "p95"), digits = 1)

```


## DraftKings prediction model
```{r}
draftkings_filtered <- draftkings_data %>% 
  semi_join(teams_playing) %>% 
  filter(draftkings_points >= 0)
draftkings_glmodel <- stats::glm(
  draftkings_points ~ 
    draftkings_salary + 
    player + 
    draftkings_position +
    opponent_team + 
    starter_y_n + 
    venue_r_h - 1, 
  data = draftkings_filtered, family = quasipoisson
)
draftkings_augmented <- broom::augment(
  draftkings_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  select(-.se.fit, -.hat:-.std.resid) %>% 
  mutate(pct = 100 * .resid / draftkings_points)
draftkings_leaderboard <- draftkings_augmented %>% 
  group_by(player, draftkings_position) %>% summarize(
    count = n(), 
    p50 = quantile(.resid, 0.50, names = FALSE), 
    p75 = quantile(.resid, 0.75, names = FALSE),
    p95 = quantile(.resid, 0.95, names = FALSE)
  ) %>% 
  arrange(desc(p50))
datatable(draftkings_leaderboard) %>% 
  formatRound(columns = c("p50", "p75", "p95"), digits = 1)

```

