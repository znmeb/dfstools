---
title: "Exploring WNBA DFS Data"
output: html_notebook
---

## Load libraries and data
```{r message=FALSE}
library(readxl)
library(tidyverse)
library(DT)
.schedule_column_names <- c("date", "time", "road_team", "home_team")
.dfs_column_names <- c(
  "dataset",
  "date",
  "player",
  "own_team",
  "opponent_team",
  "starter_y_n",
  "venue_r_h",
  "minutes",
  "usage_rate",
  "draftkings_position",
  "fanduel_position",
  "draftkings_salary",
  "fanduel_salary",
  "draftkings_points",
  "fanduel_points"
)

regular_season_schedule <- read_excel(
  "~/DFS/NBAStuffer_WNBA/2019_WNBA_Regular_Season_Original_Schedule.xlsx",
  col_names = FALSE, 
  col_types = c(
    "date",
    "text", 
    "skip", 
    "skip", 
    "text", 
    "skip",
    "skip", 
    "text", 
    "skip"
  ), skip = 7
)
names(regular_season_schedule) <- .schedule_column_names
regular_season_schedule <- regular_season_schedule %>% dplyr::mutate(
  date_time = as.POSIXct(strptime(
    paste(date, time), format = "%Y-%m-%d %I:%M %p", tz = "EST5EDT"
  ))
)

season_dfs_feed <- read_excel(
  "~/Dropbox/19-wnba-dfs/06-25-2019-wnba-season-dfs-feed.xlsx",
  skip = 2
)

player_box_score <- dfstools::player_box_score(
  "~/Dropbox/19-wnba-player/06-25-2019-wnba-season-player-feed.xlsx"
)

```

## Archetypal analysis
```{r}
## Prepare archetypal analysis input
player_totals <- player_box_score %>% 
  mutate(player_name = player_full_name) %>% 
  select(
    player_name, tot, x3p, a, st, to, bl, pts, ddbl, tdbl, min, games) %>% 
  group_by(player_name) %>% 
  summarize_if(is.numeric, sum) %>% 
  ungroup()
player_labels <- player_totals %>% select(player_name)

## Compute the three-archetype model
archetypal_analysis <- dfstools::compute_archetypes(
  player_totals, player_labels, num_archetypes = 3)
player_alphas <- archetypal_analysis[["player_alphas"]] %>% 
  mutate(PlayerCode = as_factor(sprintf(
    "%s: Rim %1.4f, Floor %1.4f",
    player_name, 
    Rim, 
    Floor
  )))
datatable(player_alphas) %>% 
  formatRound(columns = c("Rim", "Floor", "Bench"), digits = 4)

```


## FanDuel value line
```{r}
fanduel_data <- season_dfs_feed %>% dplyr::filter(!is.na(fanduel_salary))
fanduel_model <- MASS::rlm(
  1000 * fanduel_points ~ fanduel_salary, data = fanduel_data
)
fanduel_value_line <- ggplot(
  data = fanduel_data, 
  aes(fanduel_salary, fanduel_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(fanduel_value_line)

```

## DraftKings value line
```{r}
draftkings_data <- season_dfs_feed %>% dplyr::filter(!is.na(draftkings_salary))
draftkings_model <- MASS::rlm(
  1000 * draftkings_points ~ draftkings_salary, data = draftkings_data
)
draftkings_value_line <- ggplot(
  data = draftkings_data, 
  aes(draftkings_salary, draftkings_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(draftkings_value_line)

```

## FanDuel prediction model
```{r}
fanduel_filtered <- fanduel_data %>% 
  dplyr::filter(fanduel_points >= 0, 
                own_team == "Los Angeles" | own_team == "Las Vegas")
fanduel_glmodel <- stats::glm(
  fanduel_points ~ 
    fanduel_salary + player + opponent_team + starter_y_n + venue_r_h - 1, 
  data = fanduel_filtered, family = quasipoisson
)
fanduel_augmented <- broom::augment(
  fanduel_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  dplyr::select(-.se.fit, -.hat:-.std.resid) %>% 
  dplyr::mutate(pct = round(100 * .resid / fanduel_points, 1))
fanduel_leaderboard <- fanduel_augmented %>% 
  group_by(player) %>% summarize(
    count = n(), 
    p50 = round(quantile(pct, 0.50, names = FALSE), 2), 
    p75 = round(quantile(pct, 0.75, names = FALSE), 2),
    p95 = round(quantile(pct, 0.95, names = FALSE), 2)
  ) %>% 
  arrange(desc(p50))
DT::datatable(fanduel_leaderboard)

```


## DraftKings prediction model
```{r}
draftkings_filtered <- draftkings_data %>% 
  dplyr::filter(draftkings_points >= 0, 
                own_team == "Los Angeles" | own_team == "Las Vegas")
draftkings_glmodel <- stats::glm(
  draftkings_points ~ 
    draftkings_salary + player + opponent_team + starter_y_n + venue_r_h - 1, 
  data = draftkings_filtered, family = quasipoisson
)
draftkings_augmented <- broom::augment(
  draftkings_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  dplyr::select(-.se.fit, -.hat:-.std.resid) %>% 
  dplyr::mutate(pct = round(100 * .resid / draftkings_points, 1))
draftkings_leaderboard <- draftkings_augmented %>% 
  group_by(player) %>% summarize(
    count = n(), 
    p50 = round(quantile(pct, 0.50, names = FALSE), 2), 
    p75 = round(quantile(pct, 0.75, names = FALSE), 2),
    p95 = round(quantile(pct, 0.95, names = FALSE), 2)
  ) %>% 
  arrange(desc(p50))
DT::datatable(draftkings_leaderboard)

```

