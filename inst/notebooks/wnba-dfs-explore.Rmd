---
title: "Exploring WNBA DFS Data"
output: html_notebook
---

## Load libraries and data
```{r message=FALSE}
library(tidyverse)
library(DT)
library(dfstools)
library(gt)
regular_season_schedule <- dfstools::bdb_wnba_schedule(
  "~/DFS/NBAStuffer_WNBA/2019_WNBA_Regular_Season_Original_Schedule.xlsx"
)
this_week <- regular_season_schedule %>% 
  dplyr::filter(
    game_start_time > '2019-07-01',
    game_start_time < '2019-07-08'
  )

season_dfs_feed <- dfstools::bdb_wnba_dfs(
  "~/Dropbox/19-wnba-dfs/07-03-2019-wnba-season-dfs-feed.xlsx"
) %>% 
  dplyr::filter(!is.na(fanduel_salary), !is.na(draftkings_salary))

# negative points crash the GLM quasi-poisson
season_dfs_feed$fanduel_points <- 
  pmax(season_dfs_feed$fanduel_points, 0)
season_dfs_feed$draftkings_points <-
  pmax(season_dfs_feed$draftkings_points, 0)
season_dfs_feed <- season_dfs_feed %>% dplyr::mutate(
  fanduel_value = 1000 * fanduel_points / fanduel_salary,
  draftkings_value = 1000 * draftkings_points / draftkings_salary
)

player_box_score <- dfstools::player_box_score(
  "~/Dropbox/19-wnba-player/07-03-2019-wnba-season-player-feed.xlsx"
)
last_game_played <- season_dfs_feed %>% 
  dplyr::group_by(player_name, own_team) %>% 
  dplyr::summarize(games = n(), last_game = max(game_date)) %>% 
  ungroup()

# who's playing where?
road_players <- this_week %>% 
  dplyr::left_join(last_game_played, by = c("road_team" = "own_team")) %>%
  select(player_name, opp_team = home_team) %>% 
  mutate(venue_r_h = "Road")
home_players <- this_week %>% 
  dplyr::left_join(last_game_played, by = c("home_team" = "own_team")) %>%
  select(player_name, opp_team = road_team) %>% 
  mutate(venue_r_h = "Home")
to_project <- dplyr::bind_rows(road_players, home_players)

season_team_feed <- dfstools::bdb_wnba_team("~/Dropbox/19-wnba-team/07-03-2019-wnba-season-team-feed.xlsx")

```

## Game predictions
```{r}
rank_model <- dfstools::bdb_wnba_rank_model(season_team_feed)
augmented_schedule <- dfstools::game_predict(
  regular_season_schedule, rank_model
)
game_score_projections <- augmented_schedule %>%
  dplyr::semi_join(this_week) %>% 
  dplyr::select(
    `Game Start (EDT)` = game_start_time,
    "Road Team" = road_team,
    "Home Team" = home_team,
    "Projected Road Score" = road_team_score_p,
    "Projected Home Score" = home_team_score_p,
    "Projected Total" = total_p,
    "Projected Home Margin of Victory"= home_team_mov_p
  )
game_score_projections %>% gt() %>% 
  gtsave(filename = "game_score_projections_20190702.png")

```

## Fantasy points predictions
```{r}
fanduel_training <- season_dfs_feed %>% 
  dplyr::select(player_name, opp_team, venue_r_h, fanduel_points)
fanduel_glmodel <- stats::glm(fanduel_points ~ 
    player_name + 
    opp_team + 
    venue_r_h - 1, 
  data = fanduel_training, family = quasipoisson
)
draftkings_training <- season_dfs_feed %>% 
  dplyr::select(player_name, opp_team, venue_r_h, draftkings_points)
draftkings_glmodel <- stats::glm(draftkings_points ~ 
    player_name + 
    opp_team + 
    venue_r_h - 1, 
  data = draftkings_training, family = quasipoisson
)
dfs_projections <- to_project %>% 
  dplyr::mutate(
    projected_fanduel_points = round(predict(
      fanduel_glmodel, newdata = to_project, type = "response"), 2),
    projected_draftkings_points = round(predict(
      draftkings_glmodel, newdata = to_project, type = "response"), 2)
  ) %>% 
  dplyr::left_join(last_game_played) %>%
  dplyr::mutate(
    game_slug = ifelse(venue_r_h == "Home", paste0(opp_team, " @ ", own_team),
                       paste0(own_team, " @ ", opp_team))
  ) %>% 
  dplyr::arrange(game_slug, desc(projected_fanduel_points))

```

