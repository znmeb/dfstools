---
title: "Exploring WNBA DFS Data"
output: html_notebook
---

## Load libraries and data
```{r message=FALSE}
library(readxl)
library(tidyverse)
library(Rmixmod)
library(DT)
.dfs_column_names <- c(
  "dataset",
  "date",
  "player",
  "own_team",
  "opponent_team",
  "starter_y_n",
  "venue_r_h",
  "minutes",
  "usage_rate",
  "draftkings_position",
  "fanduel_position",
  "draftkings_salary",
  "fanduel_salary",
  "draftkings_points",
  "fanduel_points"
)
regular_season_schedule <- read_excel(
  "~/DFS/NBAStuffer_WNBA/2019_WNBA_Regular_Season_Original_Schedule.xlsx",
  col_names = FALSE, 
  col_types = c(
    "date",
    "text", 
    "skip", 
    "skip", 
    "text", 
    "skip",
    "skip", 
    "text", 
    "skip"
  ), skip = 7
)
names(regular_season_schedule) <- c("date", "time", "road_team", "home_team")
regular_season_schedule <- regular_season_schedule %>% dplyr::mutate(
  date_time = as.POSIXct(strptime(
    paste(date, time), format = "%Y-%m-%d %I:%M %p", tz = "EST5EDT"
  ))
)

wnba_season_dfs_feed <- read_excel(
  "~/Dropbox/19-wnba-dfs/06-25-2019-wnba-season-dfs-feed.xlsx",
  skip = 2
)
names(wnba_season_dfs_feed) <- .dfs_column_names
```

## FanDuel value line
```{r}
fanduel_data <- wnba_season_dfs_feed %>% dplyr::filter(!is.na(fanduel_salary))
fanduel_model <- MASS::rlm(
  1000 * fanduel_points ~ fanduel_salary, data = fanduel_data
)
fanduel_value_line <- ggplot(
  data = fanduel_data, 
  aes(fanduel_salary, fanduel_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(fanduel_value_line)

```

## DraftKings value line
```{r}
draftkings_data <- wnba_season_dfs_feed %>% dplyr::filter(!is.na(draftkings_salary))
draftkings_model <- MASS::rlm(
  1000 * draftkings_points ~ draftkings_salary, data = draftkings_data
)
draftkings_value_line <- ggplot(
  data = draftkings_data, 
  aes(draftkings_salary, draftkings_points)
) +
  geom_point() + 
  geom_smooth(method = MASS::rlm)
print(draftkings_value_line)

```

## FanDuel prediction model
```{r}
fanduel_filtered <- fanduel_data %>% 
  dplyr::filter(fanduel_points >= 0, 
                own_team == "Los Angeles" | own_team == "Las Vegas")
fanduel_glmodel <- stats::glm(
  fanduel_points ~ 
    fanduel_salary + player + opponent_team + starter_y_n + venue_r_h - 1, 
  data = fanduel_filtered, family = quasipoisson
)
fanduel_augmented <- broom::augment(
  fanduel_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  dplyr::select(-.se.fit, -.hat:-.std.resid)
fanduel_leaderboard <- fanduel_augmented %>% 
  group_by(player) %>% summarize(
    count = n(), 
    p50 = round(quantile(.resid, 0.50, names = FALSE), 2), 
    p75 = round(quantile(.resid, 0.75, names = FALSE), 2),
    p95 = round(quantile(.resid, 0.95, names = FALSE), 2)
  ) %>% 
  arrange(desc(p50))
DT::datatable(fanduel_leaderboard)

```


## DraftKings prediction model
```{r}
draftkings_filtered <- draftkings_data %>% 
  dplyr::filter(draftkings_points >= 0, 
                own_team == "Los Angeles" | own_team == "Las Vegas")
draftkings_glmodel <- stats::glm(
  draftkings_points ~ 
    draftkings_salary + player + opponent_team + starter_y_n + venue_r_h - 1, 
  data = draftkings_filtered, family = quasipoisson
)
draftkings_augmented <- broom::augment(
  draftkings_glmodel, type.predict = "response", type.residuals = "response"
) %>% 
  dplyr::select(-.se.fit, -.hat:-.std.resid)
draftkings_leaderboard <- draftkings_augmented %>% 
  group_by(player) %>% summarize(
    count = n(), 
    p50 = round(quantile(.resid, 0.50, names = FALSE), 2), 
    p75 = round(quantile(.resid, 0.75, names = FALSE), 2),
    p95 = round(quantile(.resid, 0.95, names = FALSE), 2)
  ) %>% 
  arrange(desc(p50))
DT::datatable(draftkings_leaderboard)

```

